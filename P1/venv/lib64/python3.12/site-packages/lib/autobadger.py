import abc
import traceback

from .enums import Project
from .exceptions import MissingRequiredResource, MisconfiguredTestClass
from .runnable import Runnable, RegisteredTestClass
from .types import AutobadgerResult


class Callback(abc.ABC):
    delegate: "Autobadger"

    @abc.abstractmethod
    def on_setup(self):
        pass

    @abc.abstractmethod
    def on_teardown(self):
        pass

    @abc.abstractmethod
    def on_validate_required_resources(self):
        """
        :throws MissingRequiredResource:
        :return:
        """
        pass

    @abc.abstractmethod
    def on_before_test(self):
        pass

    @abc.abstractmethod
    def on_after_test(self):
        pass


class AutobadgerCallback(Callback):
    def __init__(self, callbacks: list[type[Callback]], delegate: "Autobadger"):
        self.callbacks = [cb() for cb in callbacks]
        for cb in self.callbacks:
            cb.delegate = delegate
        self.delegate = delegate

    def _run_callbacks(self, func_name):
        for cb in self.callbacks:
            getattr(cb, func_name)()

    def on_validate_required_resources(self):
        self._run_callbacks("on_validate_required_resources")

    def on_setup(self):
        self._run_callbacks("on_setup")

    def on_teardown(self):
        if self.delegate.clean_up:
            self._run_callbacks("on_teardown")

    def on_before_test(self):
        self._run_callbacks("on_before_test")

    def on_after_test(self):
        self._run_callbacks("on_after_test")


class Autobadger(Runnable[AutobadgerResult]):
    callbacks: list["Callback"] = []

    def __init__(
        self,
        project: Project,
        tests: list[RegisteredTestClass],
        callbacks: list[Callback],
        grade_id: str,
        target: str,
        verbose: bool = False,
        clean_up: bool = True,
    ) -> None:
        super().__init__()
        self.project = project
        self.tests = tests
        self.grade_id = grade_id
        self.target = target
        self.verbose = verbose
        self.clean_up = clean_up
        self.callback = AutobadgerCallback(callbacks, delegate=self)

    def run(self) -> AutobadgerResult:
        grade: AutobadgerResult = AutobadgerResult(project=self.project)
        total_score = sum([Test.__points__ for Test in self.tests])
        try:
            self.callback.on_validate_required_resources()
        except MissingRequiredResource as e:
            return AutobadgerResult.Zero(
                self.project, stack_trace=str(e), total=total_score
            )
        self.callback.on_setup()
        try:
            for Test in self.tests:
                grade.join(Test(self.callback, delegate=self).run())
        except MisconfiguredTestClass as e:
            raise MisconfiguredTestClass(e.class_name) from None
        except Exception as e:
            trace = "\n".join([f"{e}:", "Full Stacktrace:", traceback.format_exc()])
            grade = AutobadgerResult.Zero(self.project, trace, total=total_score)
        finally:
            self.callback.on_teardown()
        return grade

    def __call__(self, *args, **kwargs) -> AutobadgerResult:
        return self.run()
